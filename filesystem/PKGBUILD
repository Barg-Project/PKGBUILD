# Maintainer: Prograpper (Barg Developer) <ermanzero2008@gmail.com>

pkgname=filesystem
pkgver=20230701
pkgrel=1
pkgdesc='Base BargOS files'
arch=('x86_64')
license=('GPL')
url='https://github.com/Barg-Project'
depends=('iana-etc')
backup=('etc/crypttab' 'etc/fstab' 'etc/group' 'etc/gshadow' 'etc/host.conf'
        'etc/hosts' 'etc/issue' 'etc/ld.so.conf' 'etc/nsswitch.conf'
        'etc/passwd' 'etc/profile' 'etc/resolv.conf' 'etc/securetty'
        'etc/shadow' 'etc/shells' 'etc/subuid' 'etc/subgid'
        'etc/hostname' 'etc/modules-load.d/modules.conf' 'etc/vconsole.conf')
source=('crypttab' 'env-generator' 'fstab' 'group' 'gshadow' 'host.conf' 'hosts'
        'issue' 'ld.so.conf' 'locale.sh' 'nsswitch.conf' 'os-release' 'profile'
        'passwd' 'resolv.conf' 'securetty' 'shadow' 'shells' 'sysctl' 'sysusers'
        'tmpfiles' 'subuid' 'subgid' 'vconsole.conf'
        'home-local-bin.sh' 'hostname' 'modules.conf')
sha512sums=('5f268b557257a201c256663b35f510d7fede0093e44645f18dc2a447ece2112d28bd7a60816331b37b72931583eff50d9dc616b9f9e9ff6d8f982db8d5b0c008'
            '1731c4a41523e2823811fe030d8d2e86e69a0108fab244ed672e94d733e9b3c9ba282772c855d178dda38d10f431b193ad05b1a0a27c4aabff71792a5d557c09'
            'b2ddf3db123f757e68a84926223b56a227c6e4fa99f1d06972246625b62f2a1b147f934e1bb4534d326127f8441a39afa6856f6ea2c7ecf6be53391bf0083370'
            '0ade9187a5437076ec7d0f786528b0c4212e4f0c67edb87d8fd71815b144ab2876adeca7d943899d440e26d09ff7f4b3862733dc12decab202048cf640dfd5a8'
            '2d93356e221aba569c47adf6c882d56fd53ae102e4bb17909a35dab505625860a66efe4dcdd0a33f5e85a6d3eabb4b7f9b9e027f1f157a991242d03ab7cbc85e'
            'bc1e8c9be2d4c05992aa640a0862ed6d3822afc0d083d9779268a9a888edcd4527ae49c899f8aaa1878b7650187c9a484d488b159ae58a289a543c4a8cdccbca'
            '629ff56e5f4fd87de570fe5bc9af703efb9725743811541f21b6ada3c4a6e613c3a010029d7d73f4b706e33b3098337659a1ec5e556d11d952335f350ba108a8'
            '70a80e3842b82e355f28d0cc49d75dae055a8003d39c85960d165f3ed069a71a8628d62214ddab91a8beff02172e24e807d2c831be94d23baf944911bb4b3899'
            '61cc6de0bdc2feab9f8103e8b47b62fd0493e902797b50d3f813ed405058d4d2682c41c120e3fa0e2a8cf7800929054414d1e06b59fcb280585369895392c4e5'
            'SKIP'
            'bd1935ea8538591bbf328b54b470fd6bf2821748db4f38b4b13dc008a47ec64eabaeb0565d86dd196a4771d03b40d442334f34b5a22c4ad1536f202c7a657978'
            'db27e6bcd1b248893087a0c2b38ecd7c02a1b20de8eb822f0d2c7cf061cd8c8f23e41f58908881125f8a2802f75cf1a314f224f652f496eadf64c0551678095b'
            'd62db0aac2c281288cd3f8c029ff967c8348b2248e155e0710ff9d012c8caec9bfc45ee37e8ed1573eacd49757a36d908b1b1cbf67282b0ff50a82be635a0ed7'
            'df24002d74d2d543be0f8b74b36def1eba7054efd8da1943b4422048ece6d41f3e40248c2169c5c1168ba64ede2dfbd6c21d6e70bbe1ba8c82137834327eecea'
            '779049d55883fb7edf34ffd050e9d4d09252de529d776f507c1be19fd9688645d9100cf246fcd5b62ca1e1cf5408383ef02f09f3bc11203de33e5ad0ce17cda9'
            '3252ba4ae19a5ff0fe0b5e999016391943614e3c6916305be8cc6ec26533d94bc33f9ea908a8fa3aa19b304979cba1ddb0d0d1daa5a8d18398ce237780c81767'
            '67f3f7d24cdd3544fc9467efd9f8b944a012f0eb8547e4c82ed5a4d9c88e4fc2ea900c5095ff5201da242ddbbb6064c78f2ffb7378d8967c3b5a3f62c28dc636'
            'c376b93b91dd181cf50b39a187255326aa1c76fb03972353620abb86ac2014631102c9296e11cc805c7409fb346bee827c4736cfb65fb9acf060fd5ca8957e02'
            'c040d3b13b9cb6dea00e88f2d5428c80c4045eeab9b9c1cf47eb1c3bf6b1f613a9f9181cd4133a18a8e15c651de70389d8ecf0ec873259e8a74068da5a24898e'
            'e0098fd2d4bb2b8411ea072c0d8d9d34ac75c03159c2c337cc6b06f9773154868113fdad2a78299c54bf2e9937227885dfa38556ba3d51b2cfef2dd98b110b1f'
            '048013dfd2176d287a563bf604630120e8c36c5e45673711b7b5c77e652272ac1b937a9e771b776490ada158aa3c9952412c54036d7e85e310a327a4e8f4a194'
            'cf83e1357eefb8bdf1542850d66d8007d620e4050b5715dc83f4a921d36ce9ce47d0d13c5d85f2b0ff8318d2877eec2f63b931bd47417a81a538327af927da3e'
            'cf83e1357eefb8bdf1542850d66d8007d620e4050b5715dc83f4a921d36ce9ce47d0d13c5d85f2b0ff8318d2877eec2f63b931bd47417a81a538327af927da3e'
            '52a8fa68fdb22a78190e038958d798845b751aafe3227b79361fcd5cda0407269d942846085bd2f46efa12aaf4a8ac7672db0e90f948448e1767c52296200af3'
            '78f93c6d232bd1346b5d6c0469173216763df0c52f1b2e22e68a2e246189dcda1ee85ab0366a5de960179c619ce9712e964effc674cc821262cad6a3a57dea4f'
            'b0fcb55c210423851a00a48b771ce0d99db8851cf6db66fb6296b5d1b70f85ce73a7ffd8cb4436b5e054635aa94452091a41c69e6bd90e53b9137f64be14f96d'
            'd7ac1023b39d267eabfdfb64f151e50f26ef9f896381046810681cc8f8a441e4fc2e8065570067c808787930120480346ac6ca29f387b3a83b57783ca992110e')

pkgver() {
  date +%Y%m%d
}

package() {
  cd "$pkgdir"

  # setup root filesystem
  for d in boot dev etc home mnt usr var opt srv/http run; do
    install -d -m755 $d
  done
  install -d -m555 proc
  install -d -m555 sys
  install -d -m0750 root
  install -d -m1777 tmp
  # vsftpd won't run with write perms on /srv/ftp
  # ftp (uid 14/gid 11)
  install -d -m555 -g 11 srv/ftp

  # setup /etc and /usr/share/factory/etc
  install -d etc/{ld.so.conf.d,skel,profile.d} usr/share/factory/etc
  for f in fstab group hostname host.conf hosts issue ld.so.conf nsswitch.conf \
  passwd resolv.conf securetty shells profile subuid subgid vconsole.conf; do
    install -m644 "$srcdir"/$f etc/
    install -m644 "$srcdir"/$f usr/share/factory/etc/
  done
  ln -s ../proc/self/mounts etc/mtab
  for f in gshadow shadow crypttab; do
    install -m600 "$srcdir"/$f etc/
    install -m600 "$srcdir"/$f usr/share/factory/etc/
  done

  # add modules-load.d/modules
  install -D -m644 $srcdir/modules.conf etc/modules-load.d/modules.conf

  # Create the barg-release file
  echo "BargOS" > $pkgdir/etc/barg-release
	ln -s barg-release $pkgdir/etc/arch-release
  install -m644 "$srcdir"/home-local-bin.sh etc/profile.d/home-local-bin.sh
  install -m644 "$srcdir"/locale.sh etc/profile.d/locale.sh
  install -Dm644 "$srcdir"/os-release usr/lib/os-release

  # setup /var
  for d in cache local opt log/old lib/misc empty; do
    install -d -m755 var/$d
  done
  install -d -m1777 var/{tmp,spool/mail}

  # allow setgid games (gid 50) to write scores
  install -d -m775 -g 50 var/games
  ln -s spool/mail var/mail
  ln -s ../run var/run
  ln -s ../run/lock var/lock

  # setup /usr hierarchy
  for d in bin include lib share/misc src; do
    install -d -m755 usr/$d
  done
  for d in {1..8}; do
    install -d -m755 usr/share/man/man$d
  done

  # add lib symlinks
  ln -s usr/lib lib
  [[ $CARCH = 'x86_64' ]] && {
    ln -s usr/lib lib64
    ln -s lib usr/lib64
  }

  # add bin symlinks
  ln -s usr/bin bin
  ln -s usr/bin sbin
  ln -s bin usr/sbin

  # setup /usr/local hierarchy
  for d in bin etc games include lib man sbin share src; do
    install -d -m755 usr/local/$d
  done
  ln -s ../man usr/local/share/man

  # setup systemd-sysctl
  install -D -m644 "$srcdir"/sysctl usr/lib/sysctl.d/10-barg.conf

  # setup systemd-sysusers
  install -D -m644 "$srcdir"/sysusers usr/lib/sysusers.d/barg.conf

  # setup systemd-tmpfiles
  install -D -m644 "$srcdir"/tmpfiles usr/lib/tmpfiles.d/barg.conf

  # setup systemd.environment-generator
  install -D -m755 "$srcdir"/env-generator usr/lib/systemd/system-environment-generators/10-barg
}

# vim:set ts=2 sw=2 et:
